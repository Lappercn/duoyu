# 多智能体股票投顾系统 - 核心业务流程逻辑 (Workflow Logic)

## 1. 概述
本文档详细描述了当用户输入股票代码（如 `600519`）后，系统后台如何触发一条全自动的“投研流水线”。核心亮点在于**联网实时数据检索**与**多视角逻辑博弈**。

---

## 2. 详细处理流程 (Pipeline)

### 阶段一：立项与深度情报搜集 (Initialization & Deep Research)
**目标**：确保后续分析基于“真实、实时”的市场数据，而非模型过期的训练数据。

1.  **任务接单 (Controller)**
    -   接收用户请求 (`/api/analysis`)。
    -   在 MongoDB 创建任务档案，状态置为 `processing`。
    -   返回 `analysisId` 给前端，开启轮询模式。

2.  **顾问智能体 (Consultant Agent) - 数据挖掘**
    -   **角色**：数据猎手 / 情报官。
    -   **核心动作**：调用豆包大模型 Web Search 插件。
    -   **多轮检索策略 (Robust Retrieval)**：
        -   **第一轮（宏观/新闻）**：检索该股票近期的重大新闻、行业政策、市场情绪（如“茅台今日为何下跌”、“白酒板块最新政策”）。
        -   **第二轮（实时行情/财务）**：重点检索**具体的盘面核心指标**，：
            -   **价格信息**：当前价格 (Price)、当日涨跌幅 (Change%)、上一个收盘价 (Prev Close)。
            -   **日内波动**：开盘价 (Open)、当日最高 (High)、当日最低 (Low)。
            -   **量能指标**：成交量 (Volume)、平均成交量 (Avg Vol)。
            -   **估值与规模**：市盈率 (P/E Ratio)、市值 (Market Cap)、近52周最高/最低 (52-Wk Range)。
            -   **趋势图描述**：检索分时图或日K线的走势描述（如“早盘低开高走”、“尾盘跳水”）。
        -   **重试机制**：若第一轮未检索到有效行情数据，自动触发补充搜索，确保数据完整性。
    -   **产出物**：生成一份结构化的**《实时市场情报报告》**，包含：
        -   `Market Data Block`: 包含上述所有核心指标的JSON块。
        -   `News Summary`: 3-5条核心新闻摘要及链接。
        -   `Sentiment Score`: 市场情绪打分（0-100）。

### 阶段二：多空分歧构建 (Divergent Analysis)
**目标**：利用同一份情报，模拟完全相反的两种投资逻辑。

3.  **多头智能体 (Bull Agent) - 寻找 Alpha**
    -   **输入**：《实时市场情报报告》。
    -   **思维链 (CoT)**：
        -   “观察到今日最低价 `1,443.00` 接近近52周最低 `1,400.00`，说明下方支撑极强。”
        -   “市盈率 `20.22` 处于历史低位区间，具备估值修复空间。”
        -   “成交量 `232.11万` 虽低于平均 `298.33万`，但缩量下跌通常是惜售信号。”
    -   **产出**：买入建议书（侧重机会、护城河、低估值）。

4.  **空头智能体 (Bear Agent) - 风险审计**
    -   **输入**：《实时市场情报报告》。
    -   **思维链 (CoT)**：
        -   “虽然今日微涨 `+0.22%`，但从日内分时看，反弹无力，且价格仍受制于上方均线。”
        -   “当前价格 `1,450.50` 距离52周最高 `1,657.99` 已回撤较大，趋势已坏。”
        -   “成交量萎缩说明市场关注度下降，缺乏增量资金入场。”
    -   **产出**：卖出/避险建议书（侧重风险、高估值、技术面破位）。

### 阶段三：辩论与动态博弈 (Debate & Reasoning)
**目标**：通过对抗消除偏见，让决策逻辑透明化。

5.  **主持人智能体 (Host Agent) - 控场**
    -   **第一轮（陈述）**：Host 展示 Bull 和 Bear 的初始观点。
    -   **第二轮（反驳/Rebuttal）**：
        -   Host 敏锐地发现矛盾点，向 Bull 提问：“Bear 指出‘成交量萎缩缺乏增量资金’，请问你如何看待这一短期风险？”
        -   Bull 必须基于数据回应（例如：“历史数据显示，主力流出往往是散户恐慌时的洗盘特征...”）。
    -   **价值**：这一步让 AI 展示了“深度思考”的过程，而非简单的单轮问答。

### 阶段四：终审与交付 (Final Verdict)
**目标**：输出可执行、可解释的投资建议。

6.  **最终裁决**
    -   Host 综合两轮辩论的逻辑强度。
    -   结合用户的风险偏好（如用户是“保守型”，则 Bear 的风险提示权重更高）。
    -   生成最终结论：**买入 (BUY) / 卖出 (SELL) / 观望 (HOLD)**。

7.  **报告生成**
    -   汇总核心理由（Top 3）。
    -   **附带证据链**：列出顾问智能体在第一阶段检索到的**新闻原文链接**和**实时数据来源**，增强可信度。
    -   更新数据库状态为 `completed`。

---

## 3. 核心优势总结
-   **数据实时性**：通过“多轮检索策略”，解决了大模型无法获取今日股价和突发新闻的痛点。
-   **颗粒度精细化**：不仅看宏观，更深入到 **开盘/收盘/最高/最低/成交量/市盈率** 等具体盘面指标的博弈。
-   **逻辑透明性**：用户不仅看到结果，还能看到 AI 左右互搏的过程，理解决策背后的权衡。
-   **专业性模拟**：完美复刻了专业投研团队“数据员搜集 -> 分析师对冲 -> 基金经理决策”的工作流。
